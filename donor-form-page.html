<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Bikes - Donor Form</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Additional styles specific to donor form page */
        .donor-form-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 2rem 0;
        }

        .donor-form-header {
            background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
            padding: 2rem;
            text-align: center;
            border-bottom: 3px solid #1e3a8a;
            margin-bottom: 2rem;
        }

        .donor-form-header h1 {
            color: #fef3c7;
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 2px 2px 0px #1e3a8a;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
            margin: 0;
        }

        .donor-form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 2rem;
            flex: 1;
        }

        .donor-form-content {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2.5rem;
            border-radius: 0;
            box-shadow: 8px 8px 0px #1e3a8a;
            border: 3px solid #1e3a8a;
            position: relative;
        }

        .donor-form-content::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #3b82f6, #1e3a8a, #3b82f6);
            z-index: -1;
            border-radius: 0;
        }

        .donor-form-footer {
            margin-top: 2rem;
            padding: 2rem;
            text-align: center;
        }

        .back-to-admin {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: #fef3c7;
            border: 2px solid #475569;
            padding: 0.75rem 1.5rem;
            border-radius: 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 0px #334155;
            text-decoration: none;
            display: inline-block;
        }

        .back-to-admin:hover {
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
            box-shadow: 3px 3px 0px #334155;
            transform: translate(-1px, -1px);
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fef3c7;
            padding: 1.5rem;
            border-radius: 0;
            border: 3px solid #059669;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 8px 8px 0px #059669;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 0px #064e3b;
            display: none;
        }
    </style>
</head>
<body>
    <div class="donor-form-page">
        <div class="donor-form-header">
            <h1>Donation Form</h1>
            <p style="color: #fef3c7; margin-top: 0.5rem; font-family: 'Courier New', monospace;">Thank you for your donation to Phoenix Bikes!</p>
        </div>

        <div class="donor-form-container">
            <div id="successMessage" class="success-message">
                Donation submitted successfully! Thank you for your generosity.
            </div>

            <div class="donor-form-content">
                <form id="donorForm" class="donation-form">
                    <div class="form-group">
                        <label for="donorName">Donor Name *</label>
                        <input type="text" id="donorName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="donorEmail">Email Address *</label>
                        <input type="email" id="donorEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="donorPhone">Phone Number</label>
                        <input type="tel" id="donorPhone">
                    </div>
                    
                    <div class="form-group">
                        <label for="donorAddress">Address</label>
                        <textarea id="donorAddress" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="donationType">Donation Type *</label>
                        <select id="donationType" required>
                            <option value="">Select donation type</option>
                            <option value="bike">Bike(s)</option>
                            <option value="parts">Parts</option>
                            <option value="both">Bike(s) and Parts</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="numberOfBikesGroup" style="display: none;">
                        <label for="numberOfBikes">Number of Bikes *</label>
                        <input type="number" id="numberOfBikes" min="1" max="20" value="1">
                        <small style="color: #1e3a8a; font-style: italic;">How many bikes are being donated?</small>
                    </div>
                    
                    <div class="form-group" id="numberOfPartsGroup" style="display: none;">
                        <label for="numberOfParts">Number of Parts *</label>
                        <input type="number" id="numberOfParts" min="1" max="100" value="1">
                        <small style="color: #1e3a8a; font-style: italic;">Total number of parts being donated</small>
                    </div>
                    
                    <div id="dynamicDonationSections"></div>
                    
                    <div class="form-group">
                        <label for="donationNotes">Additional Notes</label>
                        <textarea id="donationNotes" rows="3" placeholder="Any additional information about the donation..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="receiptRequested" checked>
                            I would like a receipt for this donation
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
                        <button type="submit" class="btn btn-primary">Submit Donation</button>
                    </div>
                </form>
            </div>

            <div class="donor-form-footer" id="returnFooter" style="display: none;">
                <a href="index.html" class="back-to-admin">Return to Admin Interface</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load local config for development (ignored by git) -->
    <script>
        // Only load local-config.js in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const script = document.createElement('script');
            script.src = 'local-config.js';
            script.onerror = function() {
                console.warn('⚠️ local-config.js not found - using production configuration');
            };
            document.head.appendChild(script);
        }
    </script>
    <script src="config.js"></script>
    <script src="env-config.js"></script>
    <script>
        // Store brands and models globally
        window.bikeBrands = [];
        window.bikeModels = [];
        window.brandsModelsLoaded = false;
        
        // Fetch brands and models from database
        async function loadBrandsAndModels() {
            if (!window.supabaseClient) {
                console.error('Supabase client not initialized');
                return false;
            }
            
            try {
                console.log('Loading brands and models from database...');
                
                // Fetch brands
                const { data: brands, error: brandsError } = await window.supabaseClient
                    .from('brands')
                    .select('name')
                    .order('name', { ascending: true });
                
                if (brandsError) throw brandsError;
                window.bikeBrands = brands ? brands.map(b => b.name) : [];
                console.log('Loaded brands:', window.bikeBrands.length, window.bikeBrands);
                
                // Fetch models
                const { data: models, error: modelsError } = await window.supabaseClient
                    .from('models')
                    .select('name')
                    .order('name', { ascending: true });
                
                if (modelsError) throw modelsError;
                window.bikeModels = models ? models.map(m => m.name) : [];
                console.log('Loaded models:', window.bikeModels.length, window.bikeModels);
                
                window.brandsModelsLoaded = true;
                return true;
                
            } catch (error) {
                console.error('Error loading brands and models:', error);
                return false;
            }
        }
        
        // Load brands and models when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for Supabase client to initialize
            let retries = 0;
            while (!window.supabaseClient && retries < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            if (window.supabaseClient) {
                await loadBrandsAndModels();
            } else {
                console.error('Supabase client not available after waiting');
            }
        });
    </script>
    <script>
        // Generate dynamic donation sections based on type and count
        async function generateDonationSections() {
            const donationType = document.getElementById('donationType').value;
            const container = document.getElementById('dynamicDonationSections');
            const numberOfBikesGroup = document.getElementById('numberOfBikesGroup');
            const numberOfPartsGroup = document.getElementById('numberOfPartsGroup');
            
            // Ensure brands and models are loaded before generating bike sections
            if (!window.brandsModelsLoaded) {
                console.log('Brands and models not loaded yet, loading now...');
                await loadBrandsAndModels();
            }
            
            // Show/hide number input fields based on donation type
            if (donationType === 'bike') {
                numberOfBikesGroup.style.display = 'block';
                numberOfPartsGroup.style.display = 'none';
                document.getElementById('numberOfBikes').required = true;
                document.getElementById('numberOfParts').required = false;
            } else if (donationType === 'parts') {
                numberOfBikesGroup.style.display = 'none';
                numberOfPartsGroup.style.display = 'block';
                document.getElementById('numberOfBikes').required = false;
                document.getElementById('numberOfParts').required = true;
            } else if (donationType === 'both') {
                numberOfBikesGroup.style.display = 'block';
                numberOfPartsGroup.style.display = 'block';
                document.getElementById('numberOfBikes').required = true;
                document.getElementById('numberOfParts').required = true;
            } else {
                numberOfBikesGroup.style.display = 'none';
                numberOfPartsGroup.style.display = 'none';
                container.innerHTML = '';
                return;
            }
            
            // Generate sections
            container.innerHTML = '';
            
            if (donationType === 'bike' || donationType === 'both') {
                const numberOfBikes = parseInt(document.getElementById('numberOfBikes').value) || 1;
                for (let i = 1; i <= numberOfBikes; i++) {
                    container.innerHTML += generateBikeSection(i);
                }
                
                // Add event listeners for "Add New" selections
                setTimeout(() => {
                    for (let i = 1; i <= numberOfBikes; i++) {
                        setupBrandModelListeners(i);
                    }
                }, 100);
            }
            
            if (donationType === 'parts' || donationType === 'both') {
                // For parts, we just generate one section since the number is captured at the top
                container.innerHTML += generatePartsSection();
            }
        }
        
        // Generate a bike section HTML
        function generateBikeSection(index) {
            console.log('Generating bike section', index, 'with brands:', window.bikeBrands.length, 'and models:', window.bikeModels.length);
            
            const brandsOptions = window.bikeBrands && window.bikeBrands.length > 0
                ? window.bikeBrands.map(brand => 
                    `<option value="${brand}">${brand}</option>`
                  ).join('')
                : '<option value="" disabled>Loading brands...</option>';
            
            const modelsOptions = window.bikeModels && window.bikeModels.length > 0
                ? window.bikeModels.map(model => 
                    `<option value="${model}">${model}</option>`
                  ).join('')
                : '<option value="" disabled>Loading models...</option>';
            
            return `
                <div class="donation-section">
                    <h3>Bike ${index}</h3>
                    
                    <div class="form-group">
                        <label for="bikeBrand_${index}">Brand *</label>
                        <select id="bikeBrand_${index}" name="bikeBrand_${index}" required>
                            <option value="">Select brand...</option>
                            ${brandsOptions}
                            <option value="__ADD_NEW__">+ Add New Brand</option>
                        </select>
                        <input type="text" id="bikeBrandNew_${index}" name="bikeBrandNew_${index}" 
                               placeholder="Enter new brand name" 
                               style="display: none; margin-top: 0.5rem;"
                               class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="bikeModel_${index}">Model *</label>
                        <select id="bikeModel_${index}" name="bikeModel_${index}" required>
                            <option value="">Select model...</option>
                            ${modelsOptions}
                            <option value="__ADD_NEW__">+ Add New Model</option>
                        </select>
                        <input type="text" id="bikeModelNew_${index}" name="bikeModelNew_${index}" 
                               placeholder="Enter new model name" 
                               style="display: none; margin-top: 0.5rem;"
                               class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="bikeValue_${index}">Estimated Value ($) *</label>
                        <input type="number" id="bikeValue_${index}" name="bikeValue_${index}" 
                               min="0" step="0.01" required>
                    </div>
                </div>
            `;
        }
        
        // Setup listeners for brand/model "Add New" options
        function setupBrandModelListeners(index) {
            const brandSelect = document.getElementById(`bikeBrand_${index}`);
            const brandNewInput = document.getElementById(`bikeBrandNew_${index}`);
            const modelSelect = document.getElementById(`bikeModel_${index}`);
            const modelNewInput = document.getElementById(`bikeModelNew_${index}`);
            
            if (brandSelect && brandNewInput) {
                brandSelect.addEventListener('change', function() {
                    if (this.value === '__ADD_NEW__') {
                        brandNewInput.style.display = 'block';
                        brandNewInput.required = true;
                        this.required = false;
                    } else {
                        brandNewInput.style.display = 'none';
                        brandNewInput.required = false;
                        this.required = true;
                    }
                });
            }
            
            if (modelSelect && modelNewInput) {
                modelSelect.addEventListener('change', function() {
                    if (this.value === '__ADD_NEW__') {
                        modelNewInput.style.display = 'block';
                        modelNewInput.required = true;
                        this.required = false;
                    } else {
                        modelNewInput.style.display = 'none';
                        modelNewInput.required = false;
                        this.required = true;
                    }
                });
            }
        }
        
        // Generate a parts section HTML
        function generatePartsSection() {
            return `
                <div class="donation-section">
                    <h3>Parts Information</h3>
                    
                    <div class="form-group">
                        <label for="partsDescription">Parts Description</label>
                        <textarea id="partsDescription" name="partsDescription" rows="3" placeholder="Describe the parts being donated..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="partsValue">Estimated Value ($)</label>
                        <input type="number" id="partsValue" name="partsValue" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="partsCondition">Condition</label>
                        <select id="partsCondition" name="partsCondition">
                            <option value="">Select condition</option>
                            <option value="new">New</option>
                            <option value="excellent">Excellent</option>
                            <option value="good">Good</option>
                            <option value="fair">Fair</option>
                            <option value="poor">Poor</option>
                        </select>
                    </div>
                </div>
            `;
        }
        
        // Handle donation type and number changes
        const donationType = document.getElementById('donationType');
        const numberOfBikes = document.getElementById('numberOfBikes');
        const numberOfParts = document.getElementById('numberOfParts');
        
        if (donationType) {
            donationType.addEventListener('change', generateDonationSections);
        }
        
        if (numberOfBikes) {
            numberOfBikes.addEventListener('change', generateDonationSections);
            numberOfBikes.addEventListener('input', generateDonationSections);
        }
        
        if (numberOfParts) {
            numberOfParts.addEventListener('change', generateDonationSections);
            numberOfParts.addEventListener('input', generateDonationSections);
        }

        // Handle form submission
        const form = document.getElementById('donorForm');
        if (form) {
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const donationType = document.getElementById('donationType').value;
                const numberOfBikes = parseInt(document.getElementById('numberOfBikes').value) || 0;
                const numberOfParts = parseInt(document.getElementById('numberOfParts').value) || 0;
                
                // Get form data
                const formData = {
                    donor: {
                        name: document.getElementById('donorName').value,
                        email: document.getElementById('donorEmail').value,
                        phone: document.getElementById('donorPhone').value,
                        address: document.getElementById('donorAddress').value
                    },
                    donation: {
                        type: donationType,
                        notes: document.getElementById('donationNotes').value,
                        receiptRequested: document.getElementById('receiptRequested').checked
                    },
                    bikes: [],
                    parts: null,
                    numberOfParts: numberOfParts
                };
                
                // Collect bike information if applicable
                if (donationType === 'bike' || donationType === 'both') {
                    for (let i = 1; i <= numberOfBikes; i++) {
                        const brandSelect = document.getElementById(`bikeBrand_${i}`);
                        const brandNewInput = document.getElementById(`bikeBrandNew_${i}`);
                        const modelSelect = document.getElementById(`bikeModel_${i}`);
                        const modelNewInput = document.getElementById(`bikeModelNew_${i}`);
                        
                        // Get brand (either from dropdown or new input)
                        let brand = brandSelect?.value || '';
                        if (brand === '__ADD_NEW__') {
                            brand = brandNewInput?.value || '';
                        }
                        
                        // Get model (either from dropdown or new input)
                        let model = modelSelect?.value || '';
                        if (model === '__ADD_NEW__') {
                            model = modelNewInput?.value || '';
                        }
                        
                        const bike = {
                            brand: brand,
                            model: model,
                            value: parseFloat(document.getElementById(`bikeValue_${i}`)?.value) || 0
                        };
                        formData.bikes.push(bike);
                    }
                }
                
                // Collect parts information if applicable
                if (donationType === 'parts' || donationType === 'both') {
                    formData.parts = {
                        description: document.getElementById('partsDescription')?.value || '',
                        numberOfParts: numberOfParts,
                        value: parseFloat(document.getElementById('partsValue')?.value) || 0,
                        condition: document.getElementById('partsCondition')?.value || ''
                    };
                }
                
                try {
                    // Show loading state
                    const submitBtn = event.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Submitting...';
                    submitBtn.disabled = true;
                    
                    // Submit the donation
                    await submitDonation(formData);
                    
                    // Show success message
                    const successMessage = document.getElementById('successMessage');
                    successMessage.style.display = 'block';
                    
                    // Show return to admin button
                    const returnFooter = document.getElementById('returnFooter');
                    returnFooter.style.display = 'block';
                    
                    // Reset form
                    form.reset();
                    document.getElementById('dynamicDonationSections').innerHTML = '';
                    
                    // Scroll to top to see success message
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                    
                    // Hide success message after 10 seconds (but keep return button visible)
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 10000);
                    
                } catch (error) {
                    console.error('Error submitting donation:', error);
                    alert('Error submitting donation: ' + error.message);
                    
                    // Reset button state
                    const submitBtn = event.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Submit donation to database
        async function submitDonation(formData) {
            if (!window.supabaseClient) {
                throw new Error('Database connection not available');
            }
            
            try {
                // Check if donor already exists by name or email
                let donorData = null;
                
                // Try to find existing donor by email first (most reliable)
                if (formData.donor.email) {
                    const { data: existingByEmail } = await window.supabaseClient
                        .from('donors')
                        .select('*')
                        .eq('email', formData.donor.email)
                        .single();
                    
                    if (existingByEmail) {
                        donorData = existingByEmail;
                        console.log('Found existing donor by email:', donorData);
                    }
                }
                
                // If not found by email, try by name
                if (!donorData && formData.donor.name) {
                    const { data: existingByName } = await window.supabaseClient
                        .from('donors')
                        .select('*')
                        .eq('name', formData.donor.name)
                        .single();
                    
                    if (existingByName) {
                        donorData = existingByName;
                        console.log('Found existing donor by name:', donorData);
                    }
                }
                
                // If donor doesn't exist, create a new one
                if (!donorData) {
                    const { data: newDonor, error: donorError } = await window.supabaseClient
                        .from('donors')
                        .insert({
                            name: formData.donor.name,
                            email: formData.donor.email
                        })
                        .select()
                        .single();
                    
                    if (donorError) {
                        console.error('Error creating new donor:', donorError);
                        throw new Error('Could not create donor record: ' + donorError.message);
                    }
                    
                    donorData = newDonor;
                    console.log('Created new donor:', donorData);
                }
                
                // Calculate total values
                const totalBikes = formData.bikes.length;
                const totalBikeValue = formData.bikes.reduce((sum, bike) => sum + (bike.value || 0), 0);
                const totalPartsValue = formData.parts ? (formData.parts.value || 0) : 0;
                const totalPartsCount = formData.numberOfParts || 0;
                
                // Create donation record
                const donationRecord = {
                    email: formData.donor.email,
                    name: formData.donor.name,
                    total_bikes_donated: totalBikes,
                    total_estimated_value: totalBikeValue + totalPartsValue,
                    total_parts_donated: totalPartsCount
                };
                
                const { data: donationData, error: donationError } = await window.supabaseClient
                    .from('donations')
                    .insert([donationRecord])
                    .select()
                    .single();
                
                if (donationError) throw donationError;
                
                // Create bike records if applicable
                if (formData.bikes.length > 0) {
                    // First, ensure all brands exist in the brands table
                    const uniqueBrands = [...new Set(formData.bikes.map(b => b.brand).filter(b => b))];
                    for (const brandName of uniqueBrands) {
                        await window.supabaseClient
                            .from('brands')
                            .upsert({ name: brandName }, { onConflict: 'name', ignoreDuplicates: true });
                    }
                    
                    // Then, ensure all models exist in the models table
                    const uniqueModels = [...new Set(formData.bikes.map(b => b.model).filter(m => m))];
                    for (const modelName of uniqueModels) {
                        await window.supabaseClient
                            .from('models')
                            .upsert({ name: modelName }, { onConflict: 'name', ignoreDuplicates: true });
                    }
                    
                    // Now insert the bike records
                    const bikeRecords = formData.bikes.map(bike => ({
                        brand: bike.brand,
                        model: bike.model,
                        value: bike.value
                    }));
                    
                    const { error: bikeError } = await window.supabaseClient
                        .from('bikes_donated')
                        .insert(bikeRecords);
                    
                    if (bikeError) throw bikeError;
                }
                
                // Create parts record if applicable
                if (formData.parts) {
                    const partsRecord = {
                        number_of_parts: formData.parts.numberOfParts,
                        parts_value: formData.parts.value
                    };
                    
                    const { error: partsError } = await window.supabaseClient
                        .from('parts_donated')
                        .insert([partsRecord]);
                    
                    if (partsError) throw partsError;
                }
                
                return { success: true, donationId: donationData.id };
                
            } catch (error) {
                console.error('Error submitting donation:', error);
                throw error;
            }
        }

        // Reset form function
        function resetForm() {
            document.getElementById('donorForm').reset();
            document.getElementById('dynamicDonationSections').innerHTML = '';
            document.getElementById('successMessage').style.display = 'none';
        }
    </script>
</body>
</html>

